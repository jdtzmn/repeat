name: iOS Test

on:
  workflow_dispatch:
  pull_request:

jobs:
  test:
    name: Build and Test
    strategy:
      matrix:
        os: [macos-latest]
        destination: ['platform=iOS Simulator,OS=26.2,name=iPhone 17 Pro']
        xcode_version: ['26.2']
    runs-on: ${{ matrix.os }}
    env:
      BUILD_DIR: '~/.build'
      DERIVED_DATA_DIR: '~/.build/DerivedData'
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ matrix.xcode_version }}
        if: matrix.os != 'self-hosted'

      - name: List available simulators
        run: xcrun simctl list -j devices

      - uses: actions/checkout@v4

      - name: Replace spaces and commas in cache key
        env:
          CACHE_KEY: "${{ runner.os }}-${{ matrix.destination }}-${{ matrix.xcode_version }}"
        run: |
          echo "CACHE_KEY=${CACHE_KEY// /_}" >> $GITHUB_ENV
          echo "CACHE_KEY=${CACHE_KEY//,/_}" >> $GITHUB_ENV

      - name: Cache builds
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_DIR }}
          key: ${{ env.CACHE_KEY }}

      - name: Preflight simulator destination
        run: |
          set -eo pipefail
          echo "Validating simulator destination: ${DESTINATION}"
          if xcodebuild -project Repeat.xcodeproj -scheme Repeat -destination "${DESTINATION}" -showBuildSettings >/dev/null 2>&1; then
            echo "Simulator destination is available."
            exit 0
          fi

          echo "::error::Configured simulator destination is unavailable: ${DESTINATION}"
          echo "Available destinations for Repeat scheme:"
          xcodebuild -project Repeat.xcodeproj -scheme Repeat -showdestinations || true
          echo
          echo "Installed simulator runtimes:"
          xcrun simctl list runtimes || true
          echo
          echo "Available simulator devices:"
          xcrun simctl list devices available || true
          exit 1
        env:
          DESTINATION: ${{ matrix.destination }}

      - name: Build
        run: |
          defaults write com.apple.dt.Xcode IDESkipPackagePluginHandshake -bool YES
          xcodebuild build-for-testing -project Repeat.xcodeproj -scheme Repeat -destination "${DESTINATION}" -derivedDataPath "${DERIVED_DATA_DIR}" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
        env:
          DESTINATION: ${{ matrix.destination }}

      - name: Test
        run: xcodebuild test-without-building -project Repeat.xcodeproj -scheme Repeat -destination "${DESTINATION}" -derivedDataPath "${DERIVED_DATA_DIR}"
        env:
          DESTINATION: ${{ matrix.destination }}
